# USB协议
USB通信距离短,是不对等协议
USB设备按功能分为集线器和功能设备
USB拓展深度最多七层, <mark>2^7 = 127</mark> 个USB设备,每个设备 <mark>2^4 = 16</mark> 个端点
- 六个设备状态: 开机, 缺省, 地址, 配置, 连接, 挂起

- [USB协议解析](https://blog.csdn.net/zhoutaopower/article/details/82083043)

- 四种PID类,每个类有四个PID,共16个PID
    1. 令牌类: OUT, IN, SETUP, SOF
    2. 数据类: DATA0, DATA1, DATA2\*, MDATA\*
    3. 握手类: ACK, NACK, STALL, NYET\*
    4. 特殊类: PRE, ERR\*, SPLIT\*, PING\*
> Tip: 注意三个四,四种包名,四个PID类型,每个PID类型各有四个子类

- [USB设备描述结构](https://www.cnblogs.com/chd-zhangbo/p/5249955.html)
    1. 设备描述符: <mark>一个设备仅一个</mark>设备描述符,包含了设备类型、设备遵循协议、厂商ID、产品id、序列号等
    2. 配置描述符: 一个设备<mark>同一时刻</mark>只能有一种配置生效
    3. 接口描述符: 一个interface就代表一个设备
    4. 端点描述符: USB通信的基本物理单位,一个endpiont只能承载一个方向的数据
            
- 四种传输类型: 控制传输, 中断传输, 批量传输, 同步传输
    1. 控制传输: 设置阶段, 数据阶段, 状态阶段(每个阶段包含多个事务)
    2. 中断传输: 
    3. 批量传输: 
    4. 同步传输: 
        
- 事务: 令牌包(建立阶段), 数据包(数据阶段), 握手包(状态阶段)(<mark>包是最小传输单元, 不可被打断, 事务也不可被打断, 传输可被打断</mark>)

> 事务不可以​被打断, 属于一次事务的几个包必须​​连续​​，​​不能跨帧​​完成; 传输由一次到多次事务构成，​​可以跨帧​​完成

> Tip: 一个事务有至多三个包,令牌包,数据包,握手包,其中数据包不固定长度

> Confuse:  DATA0和DATA1交替工作的意义,如何确保同步的?
![](vx_images/363735505980916.png =700x)

>usb主机并不是每次端点传输时才知道是批量传输,而是只要是这个端点发来的数据,通过提前枚举保存的信息,就知道是批量传输

>USB结束靠“短包”​​：​​短于最大包长的数据包​​（包括零长度包）是通知接收方“数据发完了”的​​天然信号
---
>一个事务只能携带一个数据包,一次传输由多个事务组成, 应答机制有两层应答, 事务级应答 (普遍存在), 传输级应答 (特定于控制传输)
![](vx_images/537915758716544.png =700x)
![](vx_images/199054650305187.png =700x)
---
> 令牌包是事务的指挥官​​（指明要做什么），​​数据包是事务的搬运工​​（负责运送数据，长度可变），​​握手包是事务的质检员​​（确保数据正确送达，同步传输除外）

>USB 事务通常由​​令牌包、数据包（可选）和握手包（可选）​​ 组成, 一个PID代表一个事务

|  包名  |  -  | 起始域 | 同步域 |      PID域      |   填充域   | 校验域 | 结束域 |
| ----- | --- | ------ | ------ | -------------- | --------- | ------ | ------ |
| 令牌包 | ->  | SOP    | SYNC   | IN/OUT/SETUP   | ADDR,ENDP | CRC    | EOP    |
| 数据包 | ->  | SOP    | SYNC   | DATA0/DATA1    | DATA      | CRC    | EOP    |
| 握手包 | ->  | SOP    | SYNC   | ACK/NACK/STALL | \         | CRC    | EOP    |
|        |     |        |        |                |           |        |        |
| 帧始包 | ->  | SOP    | SYNC   | SOF            | Frame#    | CRC    | EOP    |
- 低速(D-) < 全速(D+) < 高速

**当一个USB设备被接入USB集线器端口后，USB设备开始被枚举，过程大概如下：**
![](vx_images/458205240430745.png =700x)

![](vx_images/312545722539590.png =700x)

- USB控制器可能包含的寄存器类别
![](vx_images/8508467097753.png =700x)



```puml
@startmindmap
* USB协议栈体系
** 1. 基础概念
	*** USB版本演进
		**** USB 1.x (12Mbps)
		**** USB 2.0 (480Mbps)
		**** USB 3.x (5-20Gbps)
		**** USB4/Thunderbolt
	*** 拓扑结构
		**** 主机-设备架构
		**** 集线器级联
		**** OTG双角色设备
** 2. 物理层规范
	*** 电气特性
		**** 差分信号(D+/D-)
		**** VBUS供电管理
		**** 电缆类型(TypeA/B/C)
	*** 连接器演变
		**** Standard/Mini/Micro
		**** USB-C特性
		**** 交替模式(Alt Mode)
** 3. 协议层架构
	*** 数据包结构
		**** 令牌包(Token)
		**** 数据包(Data)
		**** 握手包(Handshake)
	*** 传输类型
		**** 控制传输(枚举配置)
		**** 中断传输(实时设备)
		**** 批量传输(大文件)
		**** 同步传输(音视频)
	*** 设备枚举流程
		**** 设置地址
		**** 获取描述符
		**** 配置设备
** 4. 设备类规范
	*** 标准设备类
		**** HID人机接口
		**** MSC大容量存储
		**** Audio音频类
		**** CDC通信设备
	*** 自定义设备
		**** 供应商自定义类
		**** 复合设备设计
		**** 接口关联描述符
** 5. 主机控制器
	*** 主机控制器类型
		**** UHCI/OHCI(USB1.1)
		**** EHCI(USB2.0)
		**** xHCI(USB3.0+)
	*** 驱动栈结构
		**** Windows USBDI
		**** Linux USB Core
		**** 端点0控制管道
** 6. 开发工具链
	*** 硬件调试工具
		**** USB协议分析仪
		**** 逻辑分析仪抓包
		**** Beagle USB嗅探器
	*** 软件开发工具
		**** Wireshark USB插件
		**** USBlyzer分析软件
		**** libusb跨平台库
@endmindmap
```